# 🎯 第二章：问题定义指南

> **"正确的问题定义是成功的一半"**
> 将模糊的业务需求转化为清晰的机器学习问题

---

## 🎯 学习目标

完成本章后，你将能够：

- ✅ 10-15分钟准确识别机器学习问题类型
- ✅ 15-20分钟选择合适的评估指标
- ✅ 30-45分钟完成系统化的问题定义
- ✅ 避免常见的问题定义错误
- ✅ 将业务目标转化为可执行的ML目标

---

## 📚 本章文档导航

| 文档 | 用途 | 适用场景 | 预计时间 |
|------|------|----------|----------|
| **[problem_type_decision_tree.md](problem_type_decision_tree.md)** | 可视化决策树 | 不确定问题类型（分类/回归/聚类） | 10-15分钟 |
| **[metrics_selection_guide.md](metrics_selection_guide.md)** | 评估指标选择 | 已知问题类型，需选择评估指标 | 15-20分钟 |
| **[problem_definition_checklist.md](problem_definition_checklist.md)** | 完整工作流 | 完整项目启动，系统化定义问题 | 30-45分钟 |

---

## 🚀 三种使用模式

### 模式 1：系统学习（1-2小时，首次学习推荐）

**适合人群：** 第一次学习问题定义方法论

**学习路径：**
1. 阅读本 README，了解5步问题定义法
2. 详细阅读 [problem_type_decision_tree.md](problem_type_decision_tree.md)
3. 详细阅读 [metrics_selection_guide.md](metrics_selection_guide.md)
4. 学习 [problem_definition_checklist.md](problem_definition_checklist.md) 的完整工作流
5. 在自己的数据集上练习完整流程

### 模式 2：快速定义（10-15分钟，快速决策）

**适合人群：** 已了解方法论，需要快速确定问题类型

**使用流程：**
1. 查看下方"5步问题定义法"快速了解流程
2. 使用 [problem_type_decision_tree.md](problem_type_decision_tree.md) 确定问题类型
3. 使用 [metrics_selection_guide.md](metrics_selection_guide.md) 选择评估指标
4. 完成！

### 模式 3：深度定义（30-45分钟，项目启动）

**适合人群：** 正式项目启动，需要完整的问题定义文档

**使用流程：**
1. 使用 [problem_definition_checklist.md](problem_definition_checklist.md) 的5步工作流
2. 填写问题定义模板
3. 检查常见错误清单
4. 输出完整的问题定义文档

---

## 🎯 5步问题定义法

```
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: 理解业务目标 (10-15分钟)                              │
│  ▸ 业务问题是什么？要解决什么实际问题？                        │
│  ▸ 当前解决方案？预期改进？                                    │
│  📊 输出：业务目标卡片                                          │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 2: 确定问题类型 (5-10分钟)                               │
│  ▸ 有标签吗？→ 监督学习 / 无监督学习                          │
│  ▸ 监督学习：预测类别（分类）还是预测数值（回归）？          │
│  ▸ 无监督学习：聚类 / 降维 / 异常检测？                       │
│  📊 输出：问题类型标签                                          │
│  🔧 工具：problem_type_decision_tree.md                         │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 3: 定义输入输出 (5-10分钟)                               │
│  ▸ 输入特征有哪些？特征类型？                                  │
│  ▸ 目标变量是什么？                                            │
│  ▸ 数据量：样本数？特征数？                                    │
│  📊 输出：数据画像卡片                                          │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 4: 选择评估指标 (10-15分钟)                              │
│  ▸ 主要指标：根据业务需求和数据特征                           │
│  ▸ 次要指标：用于多角度评估                                    │
│  ▸ 指标与业务目标的对应关系                                    │
│  📊 输出：评估指标卡片                                          │
│  🔧 工具：metrics_selection_guide.md                            │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 5: 明确约束条件 (5-10分钟)                               │
│  ▸ 预测延迟要求？（实时 < 100ms / 离线）                      │
│  ▸ 可解释性要求？（高/中/低）                                  │
│  ▸ 计算资源限制？（训练/推理）                                 │
│  📊 输出：约束条件卡片 + 完整问题定义文档                      │
└─────────────────────────────────────────────────────────────────┘
```

**总耗时：** 35-60分钟
**输出：** 完整的问题定义文档，可直接用于后续算法选择和建模

---

## 🗺️ 问题类型全景图

### 监督学习（有标签）

```
监督学习
    │
    ├─ 分类问题（Classification）
    │   ├─ 二分类
    │   │   ├─ 平衡数据：垃圾邮件检测
    │   │   └─ 不平衡数据：欺诈检测、疾病诊断
    │   │
    │   ├─ 多分类（互斥类别）
    │   │   └─ 手写数字识别、新闻分类
    │   │
    │   └─ 多标签（非互斥）
    │       └─ 电影类型标注、文章标签
    │
    └─ 回归问题（Regression）
        ├─ 单变量回归：房价预测、销量预测
        └─ 多变量回归：多目标预测
```

### 无监督学习（无标签）

```
无监督学习
    │
    ├─ 聚类（Clustering）
    │   ├─ 客户分群、文档聚类
    │   └─ 图像分割、异常检测
    │
    ├─ 降维（Dimensionality Reduction）
    │   ├─ 可视化：PCA、t-SNE、UMAP
    │   ├─ 特征提取：PCA、LDA
    │   └─ 去噪：PCA、Autoencoder
    │
    └─ 异常检测（Anomaly Detection）
        ├─ 欺诈检测、设备故障
        └─ 网络入侵、质量控制
```

---

## 📊 评估指标快速参考

### 分类问题

| 场景 | 数据特征 | 推荐指标 | 原因 |
|------|----------|----------|------|
| **平衡数据** | 各类别样本数接近 | **Accuracy** | 直观，易解释 |
| **不平衡数据** | 正负样本比例悬殊 | **F1-Score, AUC** | 综合考虑精确率和召回率 |
| **医疗诊断** | 不能漏诊 | **Recall（召回率）** | 宁可误诊，不可漏诊 |
| **垃圾邮件** | 不能误拦正常邮件 | **Precision（精确率）** | 宁可漏拦，不可误拦 |
| **排序问题** | 推荐系统 | **AUC, MAP@K** | 关注排序质量 |

### 回归问题

| 指标 | 适用场景 | 特点 | 业务可解释性 |
|------|----------|------|--------------|
| **MAE** | 关注平均误差 | 对异常值不敏感 | ⭐⭐⭐ 直观 |
| **RMSE** | 关注大误差 | 惩罚大误差 | ⭐⭐ 需解释 |
| **R²** | 关注拟合程度 | 0-1之间，越高越好 | ⭐⭐⭐ 直观 |
| **MAPE** | 关注相对误差 | 百分比形式 | ⭐⭐⭐⭐ 最直观 |

### 无监督学习

| 问题类型 | 推荐指标 | 说明 |
|----------|----------|------|
| **聚类** | Silhouette Score、Davies-Bouldin Index | 内聚度和分离度 |
| **降维** | 解释方差比、重构误差 | 信息保留程度 |
| **异常检测** | Precision@K、Contamination Rate | 异常点识别准确性 |

> 💡 **详细指标选择指南**：查看 [metrics_selection_guide.md](metrics_selection_guide.md)

---

## 🛠️ 实战工具

### 快速场景导航

**我的场景是...**

| 场景描述 | 使用工具 | 预计时间 |
|----------|----------|----------|
| "我不确定这是分类还是回归问题" | 👉 [problem_type_decision_tree.md](problem_type_decision_tree.md) | 5-10分钟 |
| "我知道是分类问题，但不知道用什么指标" | 👉 [metrics_selection_guide.md](metrics_selection_guide.md) | 10-15分钟 |
| "我需要从头开始定义一个完整项目" | 👉 [problem_definition_checklist.md](problem_definition_checklist.md) | 30-45分钟 |
| "我想看实战案例学习" | 👉 阅读下方案例 + 各文档中的案例 | 20-30分钟 |

### 代码工具

```python
import numpy as np
import pandas as pd

# 工具1：问题类型检测
def identify_problem_type(y):
    """
    快速识别问题类型

    参数：
        y: 目标变量（如果无标签，传入 None）

    返回：
        问题类型字符串
    """
    if y is None:
        return "无监督学习（聚类/降维/异常检测）"

    if isinstance(y, pd.Series):
        y = y.values

    n_unique = len(np.unique(y))

    # 检测是否为数值型
    if np.issubdtype(y.dtype, np.number):
        if n_unique == 2:
            return "二分类"
        elif n_unique <= 20:
            return f"多分类（{n_unique}个类别）"
        else:
            return "回归"
    else:
        return f"分类（{n_unique}个类别）"

# 工具2：数据不平衡检测
def check_class_balance(y):
    """
    检测分类问题的类别平衡情况

    参数：
        y: 目标变量

    返回：
        类别分布信息和平衡性判断
    """
    from collections import Counter

    class_counts = Counter(y)
    total = len(y)

    print("类别分布：")
    for cls, count in sorted(class_counts.items()):
        ratio = count / total * 100
        print(f"  类别 {cls}: {count} 样本 ({ratio:.1f}%)")

    # 计算不平衡比
    max_count = max(class_counts.values())
    min_count = min(class_counts.values())
    imbalance_ratio = max_count / min_count

    print(f"\n不平衡比：{imbalance_ratio:.1f}:1")

    if imbalance_ratio < 1.5:
        print("✅ 数据平衡，可以使用 Accuracy")
    elif imbalance_ratio < 3:
        print("⚠️ 轻度不平衡，建议使用 F1-Score")
    else:
        print("❌ 严重不平衡，必须使用 F1-Score, AUC 或 Precision@K")

    return imbalance_ratio

# 使用示例
if __name__ == "__main__":
    # 示例1：识别问题类型
    y_classification = np.array([0, 1, 0, 1, 1, 0])
    y_regression = np.array([100, 200, 150, 300, 250])

    print("案例1：", identify_problem_type(y_classification))
    print("案例2：", identify_problem_type(y_regression))
    print("案例3：", identify_problem_type(None))

    print("\n" + "="*50 + "\n")

    # 示例2：检测类别平衡
    y_imbalanced = np.array([0]*95 + [1]*5)  # 严重不平衡
    check_class_balance(y_imbalanced)
```

---

## 📖 实战案例速览

### 案例1：客户流失预测

**背景**：电信公司希望预测哪些客户可能流失，以便提前干预。

**问题定义过程：**

1. **业务目标**：降低客户流失率，提升客户留存
2. **问题类型**：二分类（流失/不流失）
3. **输入特征**：
   - 客户基本信息（年龄、性别、入网时长）
   - 消费行为（月均消费、套餐类型）
   - 服务使用（通话时长、流量使用）
   - 客服记录（投诉次数、咨询次数）
4. **目标变量**：是否流失（0=留存，1=流失）
5. **评估指标**：
   - **主要指标**：AUC（关注排序能力，优先干预流失概率高的客户）
   - **次要指标**：Recall@20%（确保能捕获大部分流失客户）
6. **约束条件**：
   - 离线预测（每月预测一次）
   - 需要可解释性（中等要求，需向业务部门解释预测原因）

**预期成果**：AUC > 0.75，Recall@20% > 0.6

---

### 案例2：房价预测

**背景**：房产中介需要快速预估房屋价格。

**问题定义过程：**

1. **业务目标**：为房屋定价提供参考，误差控制在10%以内
2. **问题类型**：回归（预测连续价格）
3. **输入特征**：
   - 位置信息（区域、距离地铁站）
   - 房屋属性（面积、房龄、楼层、朝向）
   - 配套设施（学区、医院、商场）
4. **目标变量**：房屋价格（万元）
5. **评估指标**：
   - **主要指标**：MAPE（业务关注相对误差，如"预测误差5%"）
   - **次要指标**：RMSE（关注大误差，避免离谱预测）
6. **约束条件**：
   - 在线预测（<1秒响应）
   - 高可解释性（需要向客户解释定价依据）

**预期成果**：MAPE < 10%，RMSE < 50万元

---

### 案例3：客户分群（无监督学习）

**背景**：电商平台希望根据用户行为进行客户分群，以便精准营销。

**问题定义过程：**

1. **业务目标**：发现不同的客户群体特征，制定差异化营销策略
2. **问题类型**：聚类（无标签）
3. **输入特征**：
   - 购买行为（购买频率、客单价、品类偏好）
   - 活跃度（登录频率、浏览时长）
   - 用户画像（年龄段、地域）
4. **目标变量**：无（无监督学习）
5. **评估指标**：
   - **主要指标**：Silhouette Score（内聚度和分离度）
   - **业务验证**：聚类结果是否有业务可解释性
6. **约束条件**：
   - 离线分析（每周更新一次）
   - 高可解释性（聚类结果需向营销团队解释）

**预期成果**：Silhouette Score > 0.4，聚类数量3-5个，每个群体有清晰特征

---

## ⚠️ 常见错误

### 错误1：问题定义模糊

**❌ 错误示例：**
- "提升销量"
- "让模型更准"
- "做一个推荐系统"

**✅ 正确示例：**
- "预测未来7天的日销量（回归），MAE < 100件，用于库存管理"
- "将客户流失预测AUC从0.7提升到0.75，Recall@20% > 0.6"
- "构建商品推荐系统，点击率预估任务，AUC > 0.75，推理延迟 < 50ms"

### 错误2：评估指标与业务目标不一致

**❌ 错误示例：**
- 欺诈检测（正负样本1:99）用Accuracy评估 → Accuracy=99%毫无意义
- 医疗诊断用Precision评估 → 漏诊风险高

**✅ 正确示例：**
- 欺诈检测用Precision@K或F1-Score → 关注少数类
- 医疗诊断用Recall → 不能漏诊

### 错误3：忽略数据特征

**❌ 错误示例：**
- 不平衡数据（1:99）直接建模，不做处理

**✅ 正确示例：**
- 明确标注数据不平衡，选择合适的指标（F1/AUC）
- 考虑重采样或class_weight参数

> 💡 **更多错误案例和避免方法**：查看 [problem_definition_checklist.md](problem_definition_checklist.md)

---

## ✅ 学习检查清单

完成本章学习后，检查你是否能做到：

- [ ] **5分钟内**判断问题类型（分类/回归/聚类/异常检测）
- [ ] **10分钟内**根据业务场景选择合适的评估指标
- [ ] **15分钟内**列出问题定义的5个核心要素
  - 业务目标、问题类型、输入输出、评估指标、约束条件
- [ ] **30分钟内**完成一个项目的完整问题定义文档
- [ ] **识别并避免**5种常见的问题定义错误
- [ ] **使用决策树工具**快速做出决策，而不是凭感觉

**自我测试：**
1. 给定一个业务场景，你能快速确定问题类型吗？
2. 给定一个不平衡二分类问题，你会选择什么指标？
3. 你能说出医疗诊断和垃圾邮件检测的指标差异吗？

---

## 🔗 与其他章节的关系

### 学习路径

```
01_数据诊断框架 → 02_问题定义指南 → 03_算法选择矩阵
       ↓                  ↓                    ↓
    理解数据           明确目标             选择方法
```

### 具体连接

- **前置：[01_数据诊断框架](../01_data_diagnosis_framework/)**
  - 了解数据质量、分布、特征后再定义问题
  - 数据诊断结果影响问题定义（如：不平衡数据需特殊处理）

- **后置：[03_算法选择矩阵](../03_algorithm_selection_matrix/)**
  - 问题类型确定后，使用算法选择矩阵选择合适算法
  - 评估指标用于后续模型评估

- **后续：[04_预处理与特征工程](../04_preprocessing_and_features/)**
  - 问题类型影响特征工程策略
  - 评估指标指导特征重要性分析

- **实战应用：[06_综合项目](../06_comprehensive_project/)**
  - Phase 1: 问题定义（深度使用本模块工具）
  - 完整项目从问题定义开始

---

## 📚 推荐学习资源

### 下一步学习建议

1. **首次学习（推荐）**：
   - 按顺序阅读本章所有文档（1-2小时）
   - 在自己的数据集上练习问题定义
   - 使用 `problem_definition_checklist.md` 的模板

2. **快速查询（已掌握基础）**：
   - 使用 `problem_type_decision_tree.md` 快速定位
   - 使用 `metrics_selection_guide.md` 选择指标

3. **深入实践（项目应用）**：
   - 参考 `problem_definition_checklist.md` 的完整案例
   - 在 06_综合项目 中应用学到的方法

---

**最后提醒**：

> 💡 问题定义错了，后面所有努力都是白费！
> 💡 花30分钟做好问题定义，胜过花3小时盲目调参！
> 💡 不确定时，查决策树；需要完整流程时，查清单！

---

**准备好了吗？开始你的问题定义之旅！**

👉 **推荐起点**：[problem_type_decision_tree.md](problem_type_decision_tree.md)
